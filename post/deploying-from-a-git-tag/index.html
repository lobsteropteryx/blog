<!DOCTYPE html>
<html lang="en-us">
<head>
	<title>Deploying from a Git Tag with Jenkins Pipelines&middot; Notes from the Lifeboat</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="author" content="Ian Firkin">
	<meta name="description" content="Dim interlocutions">
	
	<meta name="generator" content="Hugo 0.42" />

	<!-- CSS -->
	<link rel="stylesheet" href="https://notesfromthelifeboat.com/css/main.css">
	<link rel="stylesheet" href="https://notesfromthelifeboat.com/css/syntax.css">

	<!--Favicon-->
	<link rel="shortcut icon" href="https://notesfromthelifeboat.com/favicon.ico" type="image/x-icon">

	<!-- RSS -->
	

	<!-- Font Awesome -->
	<link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

	<!-- Google Fonts -->
	<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,700italic,400italic" rel="stylesheet" type="text/css">

	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/default.min.css">
	<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
</head>

<body>
	<header class="site-header">
	<div class="branding">
		<a href="https://notesfromthelifeboat.com/">
		<img class="avatar" src="https://notesfromthelifeboat.com/img/avatar.png" alt=""/>
		</a>
		<h1 class="site-title">
			<a href="https://notesfromthelifeboat.com/">Notes from the Lifeboat</a>
		</h1>
	</div>
	<nav class="site-nav">
		<ul>
			<li><a href="/about/"> About </a></li>

			<li class="icon">
	<a href="https://notesfromthelifeboat.com/" title="">
		<i class="fa fa-fw fa-home"></i>
	</a>
</li>

<li class="icon">
	<a href="https://notesfromthelifeboat.com/index.xml" title="Subcribe">
		<i class="fa fa-fw fa-rss"></i>
	</a>
</li>

<li class="icon">
	<a href="mailto:ian.firkin@gmail.com" title="Email">
		<i class="fa fa-fw fa-envelope"></i>
	</a>
</li>











<li class="icon">
	<a href="https://github.com/lobsteropteryx" title="GitHub">
		<i class="fa fa-fw fa-github"></i>
	</a>
</li>



















<li class="icon">
	<a href="https://twitter.com/lobsteropteryx" title="Twitter">
		<i class="fa fa-fw fa-twitter"></i>
	</a>
</li>









		</ul>
	</nav>
</header>


	<div class="content">
	<article>
		<header>
			<h1 class="title">Deploying from a Git Tag with Jenkins Pipelines</h1>
			<p class="meta">
	June 16, 2018 &middot; 3 minute read

	
</p>

		</header>

		<section class="post-content">
			

<p>In a previous <a href="/post/building-git-tags-with-jenkins">post</a> I outlined a workflow to create and trigger a pipeline job in Jenkins whenever a git tag is pushed.  A common step in this type of workflow is to deploy to a staging environment once all the build and test steps are successful.</p>

<p>One way to accomplish this is by using parameters&ndash;a typical (declarative) job definition might look like:</p>
<div class="highlight"><pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="o">{</span> <span class="n">label</span> <span class="s1">&#39;myLabel&#39;</span> <span class="o">}</span>
    <span class="n">parameters</span> <span class="o">{</span>
        <span class="n">choice</span><span class="o">(</span><span class="nl">choices:</span> <span class="s1">&#39;staging\nproduction&#39;</span><span class="o">,</span> <span class="nl">description:</span> <span class="s1">&#39;Which environment?&#39;</span><span class="o">,</span> <span class="nl">name:</span> <span class="s1">&#39;ENVIRONMENT&#39;</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="n">environment</span> <span class="o">{</span>
        <span class="n">GIT_TAG</span> <span class="o">=</span> <span class="n">sh</span><span class="o">(</span><span class="nl">returnStdout:</span> <span class="kc">true</span><span class="o">,</span> <span class="nl">script:</span> <span class="s1">&#39;git describe --always&#39;</span><span class="o">).</span><span class="na">trim</span><span class="o">()</span>
    <span class="o">}</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s2">&#34;Checkout&#34;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">checkout</span> <span class="n">scm</span>
	    <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s2">&#34;Test&#34;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">sh</span><span class="o">(</span><span class="s1">&#39;make test&#39;</span><span class="o">)</span>
	    <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s2">&#34;Deploy to Staging&#34;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">when</span> <span class="o">{</span>
                <span class="n">buildingTag</span><span class="o">()</span>
                <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;ENVIRONMENT&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;staging&#39;</span>
            <span class="o">}</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">sh</span><span class="o">(</span><span class="s1">&#39;make deploy&#39;</span><span class="o">)</span>
	    <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>
<p>The above job will run a test suite for every push, and deploy to a staging environment if the commit is a tag.  The environment is based on a <code>choice</code> parameter, and the default value is the first item in the newline-separated list (in this case, <code>staging</code>).</p>

<h2 id="dealing-with-null-parameters-on-initial-run">Dealing with Null Parameters on Initial Run</h2>

<p>Since we want our tag job to run as soon as it&rsquo;s created, we have to deal with a minor issue:  Our <code>ENVIRONMENT</code> parameter may not be set on the initial run (see issues <a href="https://issues.jenkins-ci.org/browse/JENKINS-40574">JENKINS-40574</a> and <a href="https://issues.jenkins-ci.org/browse/JENKINS-41929">JENKINS-41929</a>).</p>

<p>In the case of deploying to staging, we can test for a null <code>ENVIRONMENT</code>, and set it in an     environment block:</p>
<div class="highlight"><pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="n">stage</span><span class="o">(</span><span class="s2">&#34;Deploy to Staging&#34;</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">when</span> <span class="o">{</span>
        <span class="n">buildingTag</span><span class="o">()</span>
        <span class="n">anyOf</span> <span class="o">{</span>
            <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;ENVIRONMENT&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;staging&#39;</span>
            <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;ENVIRONMENT&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="kc">null</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">environment</span> <span class="o">{</span>
        <span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="s1">&#39;staging&#39;</span>
    <span class="o">}</span>
    <span class="n">steps</span> <span class="o">{</span>
        <span class="n">sh</span><span class="o">(</span><span class="s1">&#39;make deploy&#39;</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>
<h2 id="promoting-to-production">Promoting to Production</h2>

<p>Once the changes have been evaluated in the staging environment, the same tag can be pushed to production by adding another stage:</p>
<div class="highlight"><pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="n">stage</span><span class="o">(</span><span class="s2">&#34;Deploy to Production&#34;</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">when</span> <span class="o">{</span>
        <span class="n">buildingTag</span><span class="o">()</span>
        <span class="n">environment</span> <span class="nl">name:</span> <span class="s1">&#39;ENVIRONMENT&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;production&#39;</span>
    <span class="o">}</span>
    <span class="n">steps</span> <span class="o">{</span>
        <span class="n">sh</span><span class="o">(</span><span class="s1">&#39;make deploy&#39;</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>
<p>In this stage we don&rsquo;t need to check for a null <code>ENVIRONMENT</code>, since the first run of the job will always go to staging.</p>

<p>This setup makes sense if you have a QA team doing exploratory testing in the staging environment, and you want a manually triggered deploy to production.  You can deploy to production by running the existing tag job from Jenkins, and setting the <code>ENVIRONMENT</code> parameter to <code>production</code> in the dropdown:</p>

<p><img src="/images/jenkins-deployment.png" alt="production deploy" /></p>

<h2 id="automatic-promotion">Automatic Promotion</h2>

<p>If you want to evaluate your changes in the staging environment automatically via a smoketest script, and push to production on a successful test, you don&rsquo;t need a parameter at all; you can set the <code>ENVIRONMENT</code> for each stage in the pipeline:</p>
<div class="highlight"><pre class="chroma"><code class="language-groovy" data-lang="groovy"><span class="n">pipeline</span> <span class="o">{</span>
    <span class="n">agent</span> <span class="o">{</span> <span class="n">label</span> <span class="s1">&#39;myLabel&#39;</span> <span class="o">}</span>
    <span class="n">environment</span> <span class="o">{</span>
        <span class="n">GIT_TAG</span> <span class="o">=</span> <span class="n">sh</span><span class="o">(</span><span class="nl">returnStdout:</span> <span class="kc">true</span><span class="o">,</span> <span class="nl">script:</span> <span class="s1">&#39;git describe --always&#39;</span><span class="o">).</span><span class="na">trim</span><span class="o">()</span>
    <span class="o">}</span>
    <span class="n">stages</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s2">&#34;Checkout&#34;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">checkout</span> <span class="n">scm</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">stage</span><span class="o">(</span><span class="s2">&#34;Test&#34;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">steps</span> <span class="o">{</span>
                <span class="n">sh</span><span class="o">(</span><span class="s1">&#39;make test&#39;</span><span class="o">)</span>
	    <span class="o">}</span>
        <span class="o">}</span>
	<span class="n">stage</span><span class="o">(</span><span class="s2">&#34;Deploy to Staging&#34;</span><span class="o">)</span> <span class="o">{</span>
	    <span class="n">when</span> <span class="o">{</span>
		<span class="n">buildingTag</span><span class="o">()</span>
	    <span class="o">}</span>
	    <span class="n">environment</span> <span class="o">{</span>
		<span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="s1">&#39;staging&#39;</span>
	    <span class="o">}</span>
	    <span class="n">steps</span> <span class="o">{</span>
		<span class="n">sh</span><span class="o">(</span><span class="s1">&#39;make deploy&#39;</span><span class="o">)</span>
	    <span class="o">}</span>
	<span class="o">}</span>
	<span class="n">stage</span><span class="o">(</span><span class="s2">&#34;Smoketest&#34;</span><span class="o">)</span> <span class="o">{</span>
	    <span class="n">steps</span> <span class="o">{</span>
                <span class="n">sh</span><span class="o">(</span><span class="s1">&#39;make smoketest&#39;</span><span class="o">)</span>
	    <span class="o">}</span>
        <span class="o">}</span>
	<span class="n">stage</span><span class="o">(</span><span class="s2">&#34;Deploy to Production&#34;</span><span class="o">)</span> <span class="o">{</span>
	    <span class="n">when</span> <span class="o">{</span>
	        <span class="n">buildingTag</span><span class="o">()</span>
            <span class="o">}</span>
            <span class="n">environment</span> <span class="o">{</span>
	        <span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="s1">&#39;production&#39;</span>
            <span class="o">}</span>
            <span class="n">steps</span> <span class="o">{</span>
	        <span class="n">sh</span><span class="o">(</span><span class="s1">&#39;make deploy&#39;</span><span class="o">)</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div>
<p>This approach forgoes any exploratory testing, but can make sense for simple systems.</p>

<p>Another option is to combine the two approaches.  If there are existing manual tests that are repetitive (i.e., making the same requests against URLs), a smoketest script can still offload work from the QA team; in this case, you might automatically deploy to staging, run your test scripts, and then perform an additional deployment to a QA environment for manual testing.  The final step would be a manual promotion to production, as outlined in the previous section.</p>


			
				<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "notesfromthelifeboat" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
			
		</section>
	</article>
	</div>

	<footer class="site-footer">
	<p class="text">&copy; 2020 - Released under the MIT license<br>Powered by <a href="//gohugo.io/">Hugo</a> with the <a href="//github.com/digitalcraftsman/hugo-type-theme">Type Theme</a></p>
</footer>


<script>
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-27980065-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

</body>
</html>
